<!DOCTYPE html>
<html lang="ko">

<head>
    <meta charset="UTF-8">
    <meta name="viewport" content="width=device-width, initial-scale=1.0">
    <title>Blog - Verygood Chocolate</title>
    <meta name="description" content="Verygood Chocolate Story">
    <meta name="google-adsense-account" content="ca-pub-3053552886884428">
    <link rel="stylesheet" href="./styles.css">
    <!-- CMS Data -->
    <script src="./assets/data/blogs.js"></script>
    <script async src="https://pagead2.googlesyndication.com/pagead/js/adsbygoogle.js?client=ca-pub-3053552886884428"
        crossorigin="anonymous"></script>

    <style>
        .blog-detail-page {
            max-width: 800px;
            margin: 140px auto 120px;
            padding: 0 24px;
        }

        .bd-header {
            text-align: center;
            margin-bottom: 60px;
            border-bottom: 1px solid #eee;
            padding-bottom: 40px;
        }

        .bd-meta {
            font-size: 14px;
            color: #888;
            margin-bottom: 16px;
            text-transform: uppercase;
            letter-spacing: 0.05em;
        }

        .bd-title {
            font-family: var(--menu-font);
            font-size: 38px;
            line-height: 1.25;
            margin-bottom: 0;
            color: var(--ink);
        }

        /* Rich Text Content Styles */
        .bd-content {
            font-family: var(--body-font);
            line-height: 1.8;
            font-size: 17px;
            color: #333;
        }

        .bd-content p {
            margin-bottom: 24px;
        }

        .bd-content h2 {
            font-family: var(--menu-font);
            font-size: 28px;
            margin-top: 60px;
            margin-bottom: 24px;
        }

        .bd-content h3 {
            font-size: 22px;
            font-weight: 700;
            margin-top: 40px;
            margin-bottom: 16px;
        }

        .bd-content ul,
        .bd-content ol {
            margin-bottom: 24px;
            padding-left: 20px;
        }

        .bd-content li {
            margin-bottom: 8px;
        }

        .bd-content img {
            width: 100%;
            aspect-ratio: 16 / 9;
            object-fit: cover;
            border-radius: 8px;
            display: block;
            margin: 40px 0;
            box-shadow: 0 4px 12px rgba(0, 0, 0, 0.08);
        }

        .bd-footer {
            margin-top: 80px;
            padding-top: 40px;
            border-top: 1px solid #eee;
            text-align: center;
        }

        .btn-text {
            display: inline-block;
            text-decoration: none;
            color: var(--ink);
            border-bottom: 1px solid var(--ink);
            padding-bottom: 2px;
            font-size: 14px;
            transition: opacity 0.2s;
        }

        .btn-text:hover {
            opacity: 0.6;
        }

        /* Language Toggle Switch (Reused) */
        .lang-switch {
            display: flex;
            align-items: center;
            background: #f0f0f0;
            border-radius: 20px;
            padding: 4px;
            cursor: pointer;
            border: none;
            margin-right: 12px;
            position: relative;
            width: 64px;
            height: 32px;
            transition: background 0.3s;
            outline: none;
            -webkit-tap-highlight-color: transparent;
        }

        .lang-switch .toggle-circle {
            width: 24px;
            height: 24px;
            background: white;
            border-radius: 50%;
            box-shadow: 0 2px 4px rgba(0, 0, 0, 0.1);
            position: absolute;
            left: 4px;
            top: 4px;
            transition: transform 0.3s cubic-bezier(0.4, 0.0, 0.2, 1);
            display: flex;
            align-items: center;
            justify-content: center;
            font-size: 10px;
            font-weight: 800;
            color: var(--brand);
        }

        .lang-switch.is-kr {
            background: var(--brand);
        }

        .lang-switch.is-kr .toggle-circle {
            transform: translateX(32px);
            color: #333;
        }

        @media (max-width: 768px) {
            .bd-title {
                font-size: 28px;
            }

            .bd-content {
                font-size: 16px;
            }
        }
    </style>
</head>

<body>
    <header class="topbar">
        <div class="topbar-left">
            <a href="javascript:history.back()" class="icon-btn" id="listBtn">
                <span class="icon">←</span><span class="txt">List</span>
            </a>
        </div>
        <a class="brand" href="./index.html">
            <img class="brand-img" src="./assets/logo-type.png" alt="VERYGOOD">
        </a>
        <nav class="topbar-actions" aria-label="Top actions">
            <button class="lang-switch" id="langToggle" aria-label="Switch language">
                <span class="toggle-circle">EN</span>
            </button>
            <a class="cta" href="./index.html#shop">ORDER</a>
        </nav>
    </header>

    <main class="blog-detail-page" id="mainContent">
        <!-- Rendered by JS -->
    </main>

    <footer class="footer">
        <div class="footer-inner">
            <div class="footer-left">
                <div class="footer-brand">VERYGOOD CHOCOLATE</div>
                <div class="footer-small">© <span id="year"></span> Verygood. All rights reserved.</div>
            </div>
            <div class="footer-right">
                <a href="./privacy.html"
                    style="font-size:13px; opacity:0.7; margin-right:15px; text-decoration:none;">Privacy Policy</a>
                <a href="./terms.html"
                    style="font-size:13px; opacity:0.7; margin-right:15px; text-decoration:none;">Terms of Service</a>
            </div>
        </div>
    </footer>

    <script type="module">
        import { db } from "./assets/js/firebase-config.js";
        import { doc, getDoc } from "https://www.gstatic.com/firebasejs/10.7.1/firebase-firestore.js";

        document.getElementById("year").textContent = new Date().getFullYear();

        // 1. Parse params
        const params = new URLSearchParams(window.location.search);
        const pid = params.get("id");
        let currentLang = params.get("lang") || "EN";
        let postData = null;

        async function initPage() {
            // First check static data
            postData = blogs.find(b => b.id === pid);

            // If not found, check Firestore
            if (!postData && pid) {
                try {
                    const docRef = doc(db, "blogs", pid);
                    const docSnap = await getDoc(docRef);
                    if (docSnap.exists()) {
                        postData = { id: docSnap.id, ...docSnap.data() };
                    }
                } catch (e) {
                    console.log("Firestore fetch skipped or failed", e);
                }
            }

            renderPost();
        }

        function renderPost() {
            const isKr = currentLang === "KR";

            // Update Header UI
            const toggleBtn = document.getElementById("langToggle");
            toggleBtn.classList.toggle("is-kr", isKr);
            toggleBtn.querySelector(".toggle-circle").textContent = isKr ? "KR" : "EN";

            const listBtnText = document.querySelector("#listBtn .txt");
            listBtnText.textContent = isKr ? "목록" : "List";

            // Update Content
            const main = document.getElementById("mainContent");

            if (!postData) {
                main.innerHTML = `
                    <div style="text-align:center; padding:100px 0;">
                        <h2>${isKr ? "글을 찾을 수 없습니다" : "Post not found"}</h2>
                        <a href="./blog.html?lang=${currentLang}" class="btn-text">${isKr ? "목록으로 돌아가기" : "Back to List"}</a>
                    </div>
                `;
                return;
            }

            const title = (isKr && postData.title_ko) ? postData.title_ko : postData.title;
            const content = (isKr && postData.content_ko) ? postData.content_ko : postData.content;

            main.innerHTML = `
                <article>
                    <div class="bd-header">
                        <div class="bd-meta">${postData.date}</div>
                        <h1 class="bd-title">${title}</h1>
                    </div>
                    <div class="bd-content">
                        ${content}
                    </div>
                    <div class="bd-footer">
                        <a href="./blog.html?lang=${currentLang}" class="btn-text">${isKr ? "목록으로 돌아가기" : "Back to List"}</a>
                    </div>
                </article>
            `;
        }

        // Init
        initPage();

        // Toggle Event
        document.getElementById("langToggle").addEventListener("click", () => {
            currentLang = currentLang === "EN" ? "KR" : "EN";
            const newUrl = new URL(window.location);
            newUrl.searchParams.set("lang", currentLang);
            window.history.replaceState({}, "", newUrl);
            renderPost();
        });

    </script>
</body>

</html>